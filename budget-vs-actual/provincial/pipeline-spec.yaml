budget-vs-actual-provincial:
  title: Provincial budgeted and actual expenditure
  description: Combined dataset which consists of EPRE of all financial years.
  pipeline:

    ### EPRE
    - run: load
      parameters:
        name: epre-2019-20
        from: 'https://archive.org/download/prvepre201920fromjeffery20190603t14122/PRV%20EPRE%202019-20-from-jeffery-2019-06-03t1412%20%282%29.csv'
      cache: true

    - run: set_types
      parameters:
        resources: epre-2019-20
        types:
          Value:
            type: number

    - run: filter
      parameters:
        resources: epre-2019-20
        in:
          - FinancialYear: '2019'

    - run: delete_fields
      parameters:
        resources: epre-2019-20
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: epre-2019-20
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: epre-2019-20
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    - run: load
      parameters:
        name: epre-2018-19
        from: 'http://datastore.openspending.org/b9d2af843f3a7ca223eea07fb608e62a/estimates-of-provincial-expenditure-2018-19-uploaded-2019-05-01t1328/final/data/epre-2018-19.csv'
      cache: true

      # because otherwise string "addition" happens which looks like
      # '7871520' + '9700802' + '-152' + '100000' = '100000-15297008027871520'
    - run: set_types
      parameters:
        resources: epre-2018-19
        types:
          value:
            type: number

    - run: filter
      parameters:
        resources: epre-2018-19
        in:
          - finyear: '2018'

    - run: delete_fields
      parameters:
        resources: epre-2018-19
        fields:
          - voteno
          - sprogno
          - subprogramme

    - run: join
      parameters:
        source:
          name: epre-2018-19
          key:
            - "province"
            - "department"
            - "progno"
            - "programme"
            - "fg1"
            - "fg2"
            - "econ1"
            - "econ2"
            - "econ3"
            - "econ4"
            - "econ5"
            - "finyear"
            - "budget_phase"
          delete: yes
        target:
          name: epre-2018-19
          key: null
        fields:
          "province": {}
          "department": {}
          "progno": {}
          "programme": {}
          "fg1": {}
          "fg2": {}
          "econ1": {}
          "econ2": {}
          "econ3": {}
          "econ4": {}
          "econ5": {}
          "finyear": {}
          "budget_phase": {}
          "value":
            aggregate: sum
        full: true

    - run: load
      parameters:
        from: 'https://data.vulekamali.gov.za/dataset/9ac6e267-77e3-44a4-bd99-9a31a7112875/resource/4d5579ca-de40-4c2f-8d5b-55e4432da78a/download/estimates-of-provincial-expenditure-south-africa-2017-18.csv'
        name: 'epre-2017-18'
        format: 'csv'
      cache: true

    - run: filter
      parameters:
        resources: epre-2017-18
        in:
          - financial_year: '2017'

    - run: load
      parameters:
        from: 'https://data.vulekamali.gov.za/dataset/918a7ab3-717c-48a4-a665-bc8f88cd92d8/resource/eb07976c-5f3b-48be-84f1-3589f83da123/download/estimates-of-provincial-expenditure-south-africa-2016-17.csv'
        name: 'epre-2016-17'
        format: 'csv'
      cache: true

    - run: filter
      parameters:
        resources: epre-2016-17
        in:
          - financial_year: '2016'

    - run: load
      parameters:
        from: 'https://data.vulekamali.gov.za/dataset/5c619f67-c06b-489e-b8ef-7d8842975f8f/resource/b65549ba-927f-44a5-a780-ccfd8bb8ecf8/download/estimates-of-provincial-expenditure-south-africa-2015-16.csv'
        name: 'epre-2015-16'
        format: 'csv'
      cache: true

    - run: filter
      parameters:
        resources: epre-2015-16
        in:
          - financial_year: '2015'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
        fields:
          -
            operation: constant
            target: AmountKind
            with: 'Total'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
        fields:
        - operation: format
          target: corrected_econ2
          with: '{economic_classification_1}'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
        fields:
        - operation: format
          target: corrected_econ3
          with: '{economic_classification_2}'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
        fields:
        - operation: format
          target: corrected_econ4
          with: '{economic_classification_3}'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
        fields:
        - operation: format
          target: corrected_econ5
          with: '{economic_classification_4}'

    - run: concatenate
      parameters:
        sources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
        target:
          name: budget-vs-actual-provincial
          path: data/budget-vs-actual-provincial.csv
        fields:
          BudgetPhase: ['budget_phase']
          Department: ['department']
          Government: ['government', 'province']
          EconomicClassification1: ['econ1', 'corrected_econ1']
          EconomicClassification2: ['econ2', 'corrected_econ2']
          EconomicClassification3: ['econ3', 'corrected_econ3']
          EconomicClassification4: ['econ4', 'corrected_econ4']
          EconomicClassification5: ['econ5', 'corrected_econ5']
          FunctionGroup1: ['fg1']
          FunctionGroup2: ['fg2']
          ProgNumber: ['ProgNo', 'progno', 'Progno', 'programme_number']
          Programme: ['programme']
          AmountKind: []
          Value: ['value']
          FinancialYear: ['finyear', 'FinYear', 'financial_year']
      cache: false
    - run: dump_to_path
      parameters:
        out-path: './processed'
        format: 'csv'
